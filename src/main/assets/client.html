<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Skyway Client</title>
</head>
<body>
<h1 id="title">Skyway Client</h1>
<button id="button-play" onclick="play()">Play</button>
<button id="button-disconnect" onclick="disconnect()">Disconnect</button>
<script type="text/javascript" src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
<script>
    // Ref: https://github.com/skyway/skyway-peer-authentication-samples/blob/master/client/index.html
    const peerId = '%s';
    const apikey = '%s';
    const roomName = '%s';
    const origin = "http://localhost:%s/serve/%s";

    const audio = new Audio(origin);
    let stream = audio.captureStream();
    console.log("MediaStream id: " + stream.id);
    // submit play(); via Selenium
    audio.id = 'main-audio';
    document.body.appendChild(audio);

    let played = false;
    audio.oncanplay = () => {
        console.log("can play...");
        if (played) return;
        played = true;
        connect();
    };

    function play() {
        console.log("playing...");
        audio.play();
    }

    function connect() {
        console.log("[skyway] connecting...");
        fetch('http://localhost:%s/authenticate', {
            method: 'post',
            body: JSON.stringify({ peerId })
        })
            .then(res => res.json())
            .then(credential => {
                const peer = new Peer(peerId, {
                    key: apikey,
                    credential: credential
                });
                if (!peer) {
                    console.log("[skyway] failed to create peer");
                }
                peer.on('open', () => {
                    console.log("joining room...");
                    const room = peer.joinRoom(roomName, {
                        mode: 'sfu',
                        stream,
                        videoReceiveEnabled: false,
                        audioReceiveEnabled: false
                    });
                    if (!room) {
                        console.log("[skyway] failed to join room");
                    }
                    // let Selenium know that we have connected to room to start playing
                    const flagElt = document.createElement('div');
                    flagElt.id = 'connected-flag';
                    document.body.appendChild(flagElt);
                });
                peer.on('error', e => {
                    console.log("[skyway] peer error", e);
                });
            }).catch(reason => console.log("[skyway] Peer authentication failed", reason));
    }
    function disconnect() {
        if (room) {
            console.log("[skyway] Disconnecting from room...");
            room.close();
        }
    }
</script>
</body>
</html>