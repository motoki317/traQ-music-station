<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Skyway Client</title>
</head>
<body>
<h1 id="title">Skyway Client</h1>
<script type="text/javascript" src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
<script>
    // Ref: https://github.com/skyway/skyway-peer-authentication-samples/blob/master/client/index.html
    const peerId = '%s';
    const apikey = '%s';
    const roomName = '%s';
    const origin = "http://localhost:%s/serve/%s";

    const audio = new Audio(origin);
    let stream = audio.captureStream();
    console.log("MediaStream id: " + stream.id);
    // submit play(); via Selenium
    audio.id = 'main-audio';
    document.body.appendChild(audio);

    let played = false;
    audio.oncanplay = () => {
        console.log("can play...");
        if (played) return;
        played = true;
        connect();
    };

    let connected = false;
    function connect() {
        if (connected) return;
        connected = true;

        console.log("[skyway] connecting...");
        fetch('http://localhost:%s/authenticate', {
            method: 'post',
            body: JSON.stringify({ peerId })
        })
            .then(res => res.json())
            .then(credential => {
                const peer = new Peer(peerId, {
                    key: apikey,
                    credential: credential
                });
                if (!peer) {
                    console.log("[skyway] failed to create peer");
                }
                peer.on('open', () => {
                    console.log("joining room...")
                    const room = peer.joinRoom(roomName, {
                        mode: 'sfu',
                        stream
                    });
                    if (!room) {
                        console.log("[skyway] failed to join room");
                    }
                });
                peer.on('error', () => {
                    console.log("[skyway] peer error")
                });
            }).catch(reason => console.log("[skyway] Peer authentication failed", reason));
    }
</script>
</body>
</html>